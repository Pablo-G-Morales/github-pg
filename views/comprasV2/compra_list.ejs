<%- include('../partials/header', { title: 'Compras' }) %>

<!-- DataTables + Buttons -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">

<div class="container py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="h4 m-0">Compras</h2>
    <a href="/compras-v4" class="btn btn-success">
      <i class="fa fa-plus"></i> Nueva compra
    </a>
  </div>

  <div class="table-responsive">
    <table id="tblCompras" class="table table-sm table-striped align-middle" style="width:100%">
      <thead class="table-dark">
        <tr>
          <th>#</th>
          <th>Proveedor</th>
          <th>Fecha</th>
          <th>Bodega</th>
          <th>Estado</th>
          <th class="text-end">Total</th>
          <th class="text-nowrap">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <% if ((compras||[]).length) { compras.forEach(c => { %>
          <tr>
            <td><%= c.id %></td>
            <td><%= c.proveedor_nombre %></td>
            <td><%= c.fecha_formateada %></td>
            <td><%= c.bodega_nombre || '-' %></td>
            <td>
              <span class="badge <%= c.estado==='APROBADO' ? 'bg-success' : (c.estado==='DENEGADO' ? 'bg-danger' : (c.estado==='COMPLETADO' ? 'bg-secondary' : 'bg-warning text-dark')) %>">
                <%= c.estado %>
              </span>
            </td>
            <td class="text-end">Q <%= Number(c.total).toFixed(2) %></td>
            <td class="text-nowrap">
              <a class="btn btn-sm btn-info" href="/compras-v2/<%= c.id %>">
                <i class="fa fa-eye"></i> Ver
              </a>
              <a class="btn btn-sm btn-primary" href="/compras-v2/<%= c.id %>/editar">
                <i class="fa fa-pen"></i> Editar
              </a>
            </td>
          </tr>
        <% }) } else { %>
          <tr>
            <td colspan="7" class="text-center text-muted py-4">Sin datos para mostrar.</td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<!-- jQuery + DataTables + Buttons -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

<script>
  $(function(){
    $('#tblCompras').DataTable({
      order: [[0, 'desc']],        // ordenar por ID desc
      pageLength: 10,              // paginación
      dom: 'Bfrtip',               // Buttons + filter + table + pagination
      buttons: [
        { extend: 'copyHtml5', text: 'Copiar' },
        { extend: 'csvHtml5',  text: 'CSV'   },
        { extend: 'excelHtml5',text: 'Excel' },
        { extend: 'pdfHtml5',  text: 'PDF', orientation: 'landscape', pageSize: 'A4' },
        { extend: 'print',     text: 'Imprimir' }
      ],
      language:{
        search: "Buscar:",
        lengthMenu: "Mostrar _MENU_ registros",
        info: "_START_–_END_ de _TOTAL_",
        infoEmpty: "0–0 de 0",
        emptyTable: "Sin resultados",
        paginate:{ previous:"Anterior", next:"Siguiente" }
      },
      columnDefs: [
        { targets: 0, width: 60 },         // ID
        { targets: 6, orderable: false }   // Acciones sin orden
      ]
    });
  });
</script>

<%- include('../partials/footer') %>
